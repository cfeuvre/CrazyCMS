<?php/*Copyright CrazyCMS : Valmori Quentin	quentin.valmori@gmail.comFeuvre Christophe	neowan@live.frHaustrate Kevin	gippel5@hotmail.comThis software is a computer program whose purpose is to make our own website. You just have to follow the automatic installation procedureand you website is operational. Moreover, He is securized and optimized as much as possible.This software is governed by the CeCILL² license under French law andabiding by the rules of distribution of free software.  You can  use, modify and/ or redistribute the software under the terms of the CeCILL²license as circulated by CEA, CNRS and INRIA at the following URL"http://www.cecill.info". The fact that you are presently reading this means that you have hadknowledge of the CeCILL² license and that you accept its terms.*/if(!defined('CCMS'))die('' );if( isset($_GET['del']) AND isset($_GET['news']) AND ( ereg("del_comment;",$permissions) OR $grade==4 ) ){	$req_verif = $Bdd->sql('SELECT id FROM '.PT.'_comment WHERE id="'.intval($_GET['del']).'"' );		if($Bdd->get_num_rows($req_verif)==1){		$template->set_filename ( 'haut_mods.tpl' );		$template->assign_block_vars ( 'mod_titre' , array (		'TITRE' => news ) );		$template->set_filename ( './modules/news/viewnews.tpl' );		$Bdd->sql('DELETE FROM '.PT.'_comment WHERE id="'.intval($_GET['del']).'"' );		$Bdd->sql('UPDATE  '.PT.'_news SET comments=comments-1 WHERE id="'.intval($_GET['news']).'"' );		$Bdd->delete_cached_data('news' );		$template->assign_block_vars ( 'text' , array (		'TXT' => comments_successfully_deleted,		'URL' => 'index.php?mods=news',		'BACK' => back ) );		$template->set_filename ( 'bas_mods.tpl' );	}	else{		// Si l'utilisateur n'a rien a faire la, on lui dit ;)		$template->set_filename('error_page.tpl' );		$template->assign_vars ( array ( 'ACCESS_UNAUTHORIZED' => ACCESS_UNAUTHORIZED ) );	}}else{	//On vérifie si on a bien un chiffre	$news = (isset($_GET['news'])?intval($_GET['news']):1);	// Permission d'edit general;	$grades = explode ( ',' , $news_grade_admin );	if($grade==4 || in_array ( $grade , $grades , TRUE ) )		$secu = true;	else		$secu = false;	//On sélectionne toutes les entrées dans les tables news & commenaires	$reqnews = $Bdd->get_cached_data('	SELECT 		n.id AS idnews,		n.titre AS titrenews,		n.date AS datenews,		n.publication AS publicationnews,		n.auteur AS auteurnews,		n.parent AS parentnews,		n.contenu AS contenunews, 		n.hit AS hitnews,		n.smileys AS smileysnews,		n.groupes AS groupesnews,		n.comments AS commentsnews,		n.add_coment AS add_comentnews,		u.id AS idusers,		u.pseudo AS pseudomembre	FROM 		'.PT.'_news AS n	LEFT JOIN 		'.PT.'_users AS u	ON 		u.id=n.auteur	WHERE 		'.( ( $secu ) ? ('') : ('n.valid="1" &&') ).' n.id="'.$news.'" 	AND 		n.publication <= "'.time().'"',3600,'news' );	//On regarde si il y a au moins 1 entrée	if ( $Bdd->num_rows ( $reqnews ) > 0 ){		//On traite les données		$rep = $reqnews[0];		//On regarde si le membre est autorisé a voir la news		$perm = false;		if($rep['groupesnews'] ==''){			$perm = true;		}		else{			//On regarde si le gorupe du membre est le même que celui de la news, ou si la news est visible par tout le monde			$news_groupe = explode(';',$rep['groupesnews']);				foreach ( $news_groupe as $news_see ){				if (eregi(';'.$news_see.';',$groupe) || eregi('^'.$news_see.';',$groupe)){						$perm = true;					}				}		}		//Si l'utilisateur a le droit de voir la news, on lui affiche ;)		if($perm===true){			// Si la date de publication est dépassé, on affiche la news ;)			$titre = to_html($rep['titrenews']);			// Recuperation du contenu. On remplace les balises de découpes par du vide c'est mieux :D			$contenunews_noncoupe = str_replace('-.-' , '',$rep['contenunews']);			$texte = to_html($contenunews_noncoupe);					// On change le titre global de la PAge			$template->assign_vars(array('TITLE' => $nom_site.'-'.$titre));			$template->set_filename ( 'haut_mods.tpl' );			$template->set_filename ( './modules/news/viewnews.tpl' );			$template->assign_block_vars ( 'mod_titre' , array ( 'TITRE' => $titre ) );			$template->assign_block_vars ( 'news' , array (			'JS' => '<script type="text/javascript" src="./mods/ajax/real_time_edit.js"></script>',			'ID' => $rep['idnews'],			'TXT' => $texte,			'BY' => by,			'ID_USER' => $rep['idusers'],			'PSEUDO' => htmlspecialchars ( $rep['pseudomembre'] ),			'THE' => the,			'DATE' => ccmsdate ( $fuseaux , $rep['datenews'] ) ) );			//On incrémente le nombre de hits!			$rep['hitnews']++;			//On met a jour en bdd			$Bdd->sql('UPDATE '.PT.'_news SET hit="'.$rep['hitnews'].'" WHERE id="'.$news.'"' );			if( ereg( "poster_comment;",$permissions ) || $grade==4)			$template->assign_block_vars ( 'news.add_comment' , array (			'ID' => $rep['idnews'],			'ADD' => add_comment ) );		if ( $secu )			$template->assign_block_vars ( 'news.edit' , array (			'ID' => $rep['idnews'],			'EDIT' => edit,			'THEME' => $u_theme,			'LANG' => $u_lang,			'PWD' => $user_password,			'UID' => $uid,			'USER_AGENT' => htmlspecialchars ( $_SERVER['HTTP_USER_AGENT'] ) ) );						//On cherche les commentaires			$query2 = $Bdd->get_cached_data('			SELECT 				c.id AS idcom,				c.parent AS parentcom, 				c.contenu AS contenucom,				c.date AS datecom,				c.auteur AS auteurcom,				c.smileys AS smileyscom ,				u.id AS idusers,				u.pseudo AS pseudomembre			FROM '.PT.'_comment AS c			LEFT JOIN  '.PT.'_users AS u			ON c.auteur =u.id 			LEFT JOIN '.PT.'_news AS n			ON n.id="'.$news.'"			WHERE c.parent="'.$news.'" 			ORDER BY c.id ',3600,'comment' );			$i=0;			$can_edit = FALSE;			if($Bdd->num_rows($query2) >0){				foreach($query2 AS $idcom => $sql2){					$i++;					$contenu = to_html($sql2['contenucom']);					$template->assign_block_vars ( 'news.comm' , array (					'I' => $i,					'COMMENT_FROM' => comment_from,					'PSEUDO' => htmlspecialchars ( $sql2['pseudomembre'] ),					'CONTENU' => $contenu,					'DATE' => ccmsdate ( $fuseaux , $sql2['datecom'] ) ) );					if ( ereg("del_comment;",$permissions) || $grade==4)						$template->assign_block_vars ( 'news.comm.del' , array (						'JS' => '						<script type="text/javascript">							<!--								function del(id){									var req = confirm(\''.confirm_remove_com.'\' );										if(req == true){											window.location.href = "index.php?mods=news&page=viewnews&news='.$_GET['news'].'&del=" +id;											}								}							-->						</script>',						'ID' => $sql2['idcom'],						'REMOVE' => remove ) );					if( ( ereg("modif_comment;",$permissions) && $uid==$sql2['auteurcom']) || $secu === true){						$can_edit = TRUE;						$template->assign_block_vars ( 'news.comm.edit' , array (						'MODIFY' => modify,						'THEME' => $u_theme,						'LANG' => $u_lang,						'PWD' => $user_password,						'UID' => $uid,						'USER_AGENT' => htmlspecialchars ( $_SERVER['HTTP_USER_AGENT'] ),						'ID_COM' => $sql2['idcom'],						'ID_NEWS' => intval ( $_GET['news'] ) ) );					}				}			}			$template->set_filename ( 'bas_mods.tpl' );			$Bdd->delete_cached_data('news' );		}		else{			// Si l'utilisateur n'a rien a faire la, on lui dit ;)			$template->set_filename('error_page.tpl' );			$template->assign_vars ( array ( 'ACCESS_UNAUTHORIZED' => ACCESS_UNAUTHORIZED ) );		}	}	else{		// Si l'utilisateur n'a rien a faire la, on lui dit ;)		$template->set_filename('error_page.tpl' );		$template->assign_vars ( array ( 'ACCESS_UNAUTHORIZED' => ACCESS_UNAUTHORIZED ) );	}}?>