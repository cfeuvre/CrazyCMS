<?php/*Copyright CrazyCMS : Valmori Quentin	quentin.valmori@gmail.comFeuvre Christophe	neowan@live.frHaustrate Kevin	gippel5@hotmail.comThis software is a computer program whose purpose is to make our own website. You just have to follow the automatic installation procedureand you website is operational. Moreover, He is securized and optimized as much as possible.This software is governed by the CeCILL² license under French law andabiding by the rules of distribution of free software.  You can  use, modify and/ or redistribute the software under the terms of the CeCILL²license as circulated by CEA, CNRS and INRIA at the following URL"http://www.cecill.info". The fact that you are presently reading this means that you have hadknowledge of the CeCILL² license and that you accept its terms.*/// On vérifie que l'utilisateur est bien un administrateurif(!defined('CCMS'))die('' );$grades = explode ( ',' , $news_grade_admin );if($grade == 4 || in_array ( $grade , $grades , TRUE ) ){	$template->set_filename ( 'haut_mods.tpl' );	$template->set_filename ( './modules/news/admin.tpl' );		if ( isset($_POST['contenu'])){		$template->assign_block_vars ( 'mod_titre' , array (		'TITRE' => news_administration ) );		$titre = $Bdd->secure($_POST['title']);		$contenu = $Bdd->secure($_POST['contenu']);				@unlink ( './mods/news/news.xml' );		$Bdd->delete_cached_data('news' );		//Mise a joru des permissiosn de groupes		$new_permission = "";		// On recupere toutes les permissions		$queryz = $Bdd->sql('SELECT id FROM '.PT.'_groupe' );		// On fait une boucle pour lire toutes les permissions existantes		while($sqlz = mysql_fetch_array($queryz)){			if(isset($_POST['group:'.$sqlz['id']]) && $_POST['group:'.$sqlz['id']]==1){				// On ajoute aux permissions les permissions choisies				$new_permission .= $sqlz['id'].';';			}		}		if($_POST['publication']==0)			$publication = convertime(time());		else			$publication = mktime($_POST['public_hour'], $_POST['public_min'], '00', $_POST['public_month'], $_POST['public_day'], $_POST['public_year']);		if(isset($_POST['add_comment']))			$add = 1 ;		else			$add = 0 ;		if(isset($_GET['modifid']))			$Bdd->sql('UPDATE '.PT.'_news SET titre="'.$titre.'", contenu="'.$contenu.'", groupes="'.$new_permission.'" WHERE id="'.intval($_GET['modifid']).'"' );		else			$Bdd->sql('INSERT INTO '.PT.'_news VALUES ("", "'.$titre.'", "'.convertime(time()).'" , "'.$publication.'" , "'.$uid.'", "", "'.$contenu.'", "0", "1", "'.$new_permission.'", "0", "'.$add.'" ,"1")')or die('Erreur SQL !<br />'.mysql_error());;		if(isset($_GET['modifid']))			$template->assign_block_vars ( 'text' , array (			'TXT' => news_successfully_modified,			'URL' => 'index.php?mods=news&page=admin',			'BACK' => back ) );						else			$template->assign_block_vars ( 'text' , array (			'TXT' => news_successfully_posted,			'URL' => 'index.php?mods=news&page=admin',			'BACK' => back ) );			}	else if(isset($_GET['add']) || isset($_GET['modif'])){		if(isset($_GET['add']) && !isset ($_GET['modif']) ){			$template->assign_block_vars ( 'mod_titre' , array (			'TITRE' => add_news ) );			$action = 'index.php?mods=news&page=admin&add';			$form = default_form( TRUE );			$id_modif = 2;			$groupe_news = array ( 1 );		}		else if(isset($_GET['modif'])){			$id_modif = intval($_GET['modif']);			$action = 'index.php?mods=news&page=admin&modifid='.$id_modif;						$template->assign_block_vars ( 'mod_titre' , array (			'TITRE' => modify_news ) );			$req = $Bdd->sql('SELECT titre,contenu, groupes FROM '.PT.'_news WHERE id="'.$id_modif.'"') ;			$sql = $Bdd->get_array($req);			$form = default_form( TRUE , to_html ( $sql['titre'] ) , to_html ( $sql['contenu'] ) );			$groupe_news = explode ( ';' , $sql['groupes'] );		}				$template->assign_block_vars ( 'form' , array (		'ACTION' => $action,		'FORM' => $form,		'WHEN_PRINT' => when_print,		'ACTUAL_DATE' => actual_date,		'THE' => the,		'AT' => at,		'YEAR_VALUE' => date ( 'Y' , convertime ( time () ) ),		'HOUR' => hour,		'ADD_COMMENT_AUTH' => add_comment_auth,		'GROUPES_WHO_CAN_VIEW' => groupes_who_can_view,		'BACK' => back,		'VALID' => valid ) );		for($i=1;$i<=31;$i++)			$template->assign_block_vars ( 'form.day' , array (			'I' => $i ) );		for($i=1;$i<=12;$i++)			$template->assign_block_vars ( 'form.mth' , array (			'I' => $i ) );		for($i=0;$i<=23;$i++)			$template->assign_block_vars ( 'form.hr' , array (			'I' => $i ) );		for($i=0;$i<=59;$i++)			$template->assign_block_vars ( 'form.mn' , array (			'I' => $i ) );		// On recupere tous les groupes existants		$queryz = $Bdd->sql('SELECT id,nom FROM '.PT.'_groupe' );		// On fait une boucle pour lire toutes les permissions existantes		while($sqlz = mysql_fetch_array($queryz)){					$used = false ;						if ( isset ( $_GET [ 'modif' ] ) && in_array ( $id_modif , $groupe_news ) )				$used = true;						if($used == true)				$checked = 'checked="checked"';			else				$checked = '';							$template->assign_block_vars ( 'form.gr' , array (			'DESC' => $sqlz['nom'],			'ID' => $sqlz['id'],			'CHECKED' => $checked) );		}	}	else if(isset($_GET['del'])){		$template->assign_block_vars ( 'mod_titre' , array (		'TITRE' => news_administration ) );		$Bdd->sql('DELETE FROM '.PT.'_news WHERE id="'.intval($_GET['del']).'"' );		$Bdd->sql('DELETE FROM '.PT.'_comment WHERE parent="'.intval($_GET['del']).'"' );				@unlink ( './mods/news/news.xml' );		$template->assign_block_vars ( 'text' , array (		'TXT' => NEWS_DELETED,		'URL' => 'index.php?mods=news&page=admin',		'BACK' => back ) );		$Bdd->delete_cached_data('news' );	}	else{			$template->assign_block_vars ( 'mod_titre' , array (		'TITRE' => news_administration ) );				$template->assign_block_vars ( 'index' , array (		'JS' => '		<script type="text/javascript">			<!--				function del(id){					var req = confirm(\''.confirm_remove.'\' );					if(req == true){						window.location.href = "index.php?mods=news&page=admin&del=" + id;					}				}			-->		</script>',		'ADD' => add_news,		'GESTION' => gestion_news,		'NEWS_WAITING' => NEWS_TO_VALID,		'NEWS' => news,		'BACK' => back ) );		//On recupere toutes les news		$sql = $Bdd->sql('		SELECT 			id,			titre,			contenu		FROM 			'.PT.'_news 		WHERE 			valid="0"  		ORDER BY 			date DESC' );		$compteur = $Bdd->get_num_rows($sql) ;		if($compteur > 0){			while( $rep = $Bdd->get_array($sql))			{				$contenu_coupe = substr ( preg_replace('!<([^<]+)>!isU' , '', to_html ( $rep['contenu'] ) ) , 0 , 150 );				$template->assign_block_vars ( 'index.wnews' , array (				'TITLE' => title,				'TITLE_VALUE' => to_html ( $rep['titre'] ),				'ID' => $rep['id'],				'CONTENU' => contenu,				'CONTENU_VALUE' => $contenu_coupe,				'VALID' => VALID_NEWS,				'MODIFY' => modify,				'REMOVE' => remove ) );			}		}		else{			$template->assign_block_vars ( 'index.nwnews' , array (			'TXT' => none_news_waiting ) );		}		$sql = $Bdd->get_cached_data('		SELECT 			id,			titre,			contenu		FROM 			'.PT.'_news 		WHERE 			'.PT.'_news.valid="1" 		ORDER BY 			date DESC',3600,'news' );		foreach ($sql AS $id=> $rep ){			$contenu_coupe = substr(preg_replace('!<([^<]+)>!isU' , '', to_html ( $rep['contenu'] ) ) , 0 , 150 );			$template->assign_block_vars ( 'index.news' , array (			'TITLE' => title,			'TITLE_VALUE' => to_html ( $rep['titre'] ),			'ID' => $rep['id'],			'CONTENU' => contenu,			'CONTENU_VALUE' => $contenu_coupe,			'MODIFY' => modify,			'REMOVE' => remove ) );		}	}	$template->set_filename ( 'bas_mods.tpl' );}else{	// Si l'utilisateur n'a rien a faire la, on lui dit ;)	$template->set_filename('error_page.tpl' );	$template->assign_vars ( array ( 'ACCESS_UNAUTHORIZED' => ACCESS_UNAUTHORIZED ) );}?>