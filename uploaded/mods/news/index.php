<?php/*Copyright CrazyCMS : Valmori Quentin	quentin.valmori@gmail.comFeuvre Christophe	neowan@live.frHaustrate Kevin	gippel5@hotmail.comThis software is a computer program whose purpose is to make our own website. You just have to follow the automatic installation procedureand you website is operational. Moreover, He is securized and optimized as much as possible.This software is governed by the CeCILL² license under French law andabiding by the rules of distribution of free software.  You can  use, modify and/ or redistribute the software under the terms of the CeCILL²license as circulated by CEA, CNRS and INRIA at the following URL"http://www.cecill.info". The fact that you are presently reading this means that you have hadknowledge of the CeCILL² license and that you accept its terms.*/if(!defined('CCMS'))die('');	// On recupere les permissions generales pour l'edit ;)	$grades = explode ( ',' , $news_grade_admin );	if( $grade == 4 || in_array ( $grade , $grades , TRUE) )		$secu = true;	else		$secu = false;	$template->set_filename ( 'haut_mods.tpl' );	$template->set_filename ( './modules/news/index.tpl' );	$template->assign_block_vars ( 'index' , array (	'VIEW_ALL_NEWS' => view_all_news,	'JS' => '<script type="text/javascript" src="./mods/ajax/real_time_edit.js"></script>',	) );			//Si le visiteur est un membre ou + on selectionne les news qu'il a le droit de voir!	//J'avoue la requette semble peu lisible mais elle est si compréhensible ;)!	$sql = $Bdd->get_cached_data('		SELECT 			n.id AS idnews,			n.titre AS titrenews,			n.date AS datenews,			n.publication AS publicationnews,			n.auteur AS auteurnews,			n.parent AS parentnews,			n.contenu AS contenunews, 			n.hit AS hitnews,			n.smileys AS smileysnews,			n.groupes AS groupesnews,			n.comments AS commentsnews,			n.add_coment AS add_comentnews,			u.id AS idusers, 			u.pseudo AS pseudomembre,			u.groupe AS groupemembre			FROM '.PT.'_news AS n			LEFT JOIN '.PT.'_users AS u			ON u.id=n.auteur 		WHERE 			n.id BETWEEN 0 AND "'.$nb_news.'"			AND			n.valid=1						GROUP BY n.id		ORDER BY n.publication DESC, n.id DESC',10000,'news' );		$compt = $Bdd->num_rows($sql);	// On cree variable afin de generer le flux rss		$rss = '<?xml version="1.0" encoding="iso-8859-15" ?>	<rss version="2.0">		<channel>			<title>'.str_replace('&' , '&amp;',$nom_site).'</title>			<link>'.str_replace('&' , '&amp;',$url_site).'</link>			<description>'.$descriptif.'</description>			<language>fr</language>			<copyright>Copyright CrazyCMS</copyright>			<lastBuildDate>'.date('d  M Y \- i \: H',time()).'</lastBuildDate>			<generator>CrazyCMS</generator>	';	//on compte le nb de selection, si c'est strictement supérieur a 0 alors c'est qu'il y a des news	if($compt > 0){		//On défini le nombre de news actuellement afficher par l'user. Donc au début 0		//On traite les données		foreach ( $sql AS $id=>$qrep)		{			// Si la date de publication est dépassé, on affiche la news ;)			if($qrep['publicationnews'] <= time())			{				$perm = false;							//On regarde si le gorupe du membre est le même que celui de la news, ou si la news est visible par tout le monde				$news_groupe = explode(';',$qrep['groupesnews']);				foreach ( $news_groupe as $news_see ){				if (eregi(';'.$news_see.';',$groupe) || eregi('^'.$news_see.';',$groupe)){						$perm = true;					}				}				$verif =1;				//Recuperation titre				$titre =  to_html ( $qrep['titrenews'] );				// Recuperation du contenu.				$texte = to_html ( $qrep['contenunews'] );				//Si on trouve les balises indiquant que la news est coupée alors on la coupe (logique non? xD)				if (strpos($texte,'-.-') != FALSE){					$texte=substr($texte,0,strpos($texte,'-.-'));				}								if($qrep['groupesnews'] ==''){				$perm = true;						// On remplit le flux rss						$cont= substr ( preg_replace ( '!&lt;.+&gt;!isU' , '' , str_replace ( '<hr' , "\n<hr" , stripslashes ( htmlspecialchars ( $qrep['contenunews'] ) ) ) ) , 0 , 500 );						$rss.='<item>							<title>'.preg_replace('!&amp\;([a-zA-Z])[a-zA-Z]+\;!isU' , '$1',str_replace('&' , '&amp;',$qrep['titrenews'])).'</title>							<description>'.str_replace('&' , '&amp;',$cont).'</description>							<link>'.preg_replace('!/$!isU' , '',$url_site).'/index.php?mods=news&amp;page=viewnews&amp;news='.$qrep['idnews'].'</link>							<pubDate>'.date('d  M Y \- i \: H',$qrep['datenews']).'</pubDate>						</item>';				}												//Si l'utilisateur a le droit de voir la news, on lui affiche ;)				if($perm===true){					$template->assign_block_vars ( 'index.news' , array (					'TITRE' => $titre,					'ID' => $qrep['idnews'],					'TEXTE' => $texte,					'BY' => by,					'ID_USER' => $qrep['idusers'],					'PSEUDO' => $qrep['pseudomembre'],					'THE' => the,					'DATE' => ccmsdate($fuseaux,$qrep['datenews']),					'VIEW' => view,					'HIT' => $qrep['hitnews'],					'FOIS' => fois,					'SUITE' => lire_suite,					'COMMENTS_NBR' => $qrep['commentsnews'],					'COMMENTS' =>  ( $qrep['commentsnews'] < 2 ? comment : comments) ) );										if ( $secu )						$template->assign_block_vars ( 'index.news.edit' , array (						'EDIT' => edit,						'THEME' => $u_theme,						'LANG' => $u_lang,						'PWD' => $user_password,						'UID' => $uid,						'USER_AGENT' => htmlspecialchars ( $_SERVER['HTTP_USER_AGENT'] )) );												//On regarde si les commentaires sont autorisés et si le membre posséde la permission pour poster des commentaires						if($qrep['add_comentnews']==1 && ( ereg("poster_comment;",$permissions) || $grade==4) )							$template->assign_block_vars ( 'index.news.addc' , array (							'ADD' => add_comment ) );				}			}		}		$rss .= '</channel>			</rss>';					// On met a jour le rss si jms le fichier n'existe plus ( supprimé lors ajout , suppression ou modification news ;) )		if ( !file_exists ( './mods/news/news.xml' ) ){			$file = fopen('./mods/news/news.xml' , 'w+' );				fputs($file,$rss);			fclose($file);		}	}	else{		$template->assign_block_vars ( 'index.none' , array (		'TXT' => nobody_news ) );	}?>